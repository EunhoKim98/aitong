<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>서울시 쓰레기통 지도</title>
    <!-- 카카오 지도 api -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=7feb1956d97cd799ae256161be59914c"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            margin : 0px;
        }
        #map{
            width : 100vw; height : 100vh; min-height : 500px;
        }
    </style>
</head>
<body>
<h1>서울시 쓰레기통 지도</h1>
<button onclick="location.href='http://localhost:3000/allfile'">포화 상태 쓰레기통 목록</button>
<button onclick="location.href='http://localhost:3000/file/강남구'">강남구 포화 상태 쓰레기통 목록</button>
<button onclick="location.href='http://localhost:3000/file/서초구'">서초구 포화 상태 쓰레기통 목록</button>
<button onclick="location.href='http://localhost:3000/file/송파구'">송파구 포화 상태 쓰레기통 목록</button>
<div id="map"></div>
<script>
    var positions = [];
    var request = $.ajax({
        url: "/map",
        method: "GET",
        data: {},
        contentType: 'application/json',
    });

	request.done(function( msg ) {
        msg.forEach(function(a,b) {
			if (a.TRASHCAN_LEVEL >= 80) {
				// TRASHCAN_LEVEL 값이 80 이상인 경우
				var iconSrc = "https://www.google.com/mapfiles/marker.png";
			  } else if (a.TRASHCAN_LEVEL >= 50) {
				// TRASHCAN_LEVEL 값이 50 이상인 경우
				var iconSrc = "https://www.google.com/mapfiles/marker_orange.png";
			  } else {
				// TRASHCAN_LEVEL 값이 50 미만인 경우
				var iconSrc = "https://www.google.com/mapfiles/marker_green.png";
			  }

			  var content =  a.TRASHCAN_ID_PK + '은 ' + '<b>' + a.TRASHCAN_LEVEL + '%</b>' + ' 찼습니다.';
			  if (a.TRASHCAN_LEVEL >= 80) {
				content += '<span style="color: red;"><b><br>쓰레기통을 비워주세요!!';
			  }
			  
			  var obj = { 
				content: '<div>' + content + '</div>',
				latlng: new kakao.maps.LatLng(a.LOCATION_LAT, a.LOCATION_LONG), 
				iconSrc: iconSrc 
			  };
			  
			  positions.push(obj);			  
        });

        var mapContainer = document.getElementById('map'), // 지도를 표시할 div
            mapOption = {
                center: new kakao.maps.LatLng(37.5119, 127.059), // 지도의 중심좌표
                level: 7 // 지도의 확대 레벨
            };

        var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

        // 마커를 표시할 위치와 내용을 가지고 있는 객체 배열입니다
        for (var i = 0; i < positions.length; i ++) {
            // 마커 이미지의 이미지 크기 입니다
            var imageSize = new kakao.maps.Size(30, 30);

            // 마커 이미지를 생성합니다
            var markerImage = new kakao.maps.MarkerImage(positions[i].iconSrc, imageSize);

            // 마커를 생성합니다
            var marker = new kakao.maps.Marker({
                map: map, // 마커를 표시할 지도
                position: positions[i].latlng, // 마커의 위치
                image: markerImage // 마커 이미지
            });

		// 마커에 표시할 인포윈도우를 생성합니다
		var infowindow = new kakao.maps.InfoWindow({
			content: positions[i].content, // 인포윈도우에 표시할 내용
		});

		// 마커에 mouseover 이벤트와 mouseout 이벤트를 등록합니다
		// 이벤트 리스너로는 클로저를 만들어 등록합니다
		// for문에서 클로저를 만들어 주지 않으면 마지막 마커에만 이벤트가 등록됩니다
		kakao.maps.event.addListener(marker, 'mouseover', makeOverListener(map, marker, infowindow));
		kakao.maps.event.addListener(marker, 'mouseout', makeOutListener(infowindow));
	}

    // 인포윈도우를 표시하는 클로저를 만드는 함수입니다
	function makeOverListener(map, marker, infowindow) {
		return function() {
			infowindow.open(map, marker);
		};
	}

	// 인포윈도우를 닫는 클로저를 만드는 함수입니다
	function makeOutListener(infowindow) {
		return function() {
			infowindow.close();
		};
	}
	});
		
	request.fail(function( jqXHR, textStatus ) {
		alert( "Request failed: " + textStatus );
	});
    </script>
</body>
</html>
